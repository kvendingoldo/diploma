# -*- coding: utf-8 -*-
# @Author: Alexander Sharov

import datetime
import logging
import os
import numpy as np

from data import mesh as m
from algorithm import fem_mp as fem
from algorithm.functions_builder import get_functions
from data.plot import tri_plot
from utils import gif
from data.save import np_array
from data.plot import contour_lines as cs

DATA_DIR = '/Users/ashraov/data/%s' % datetime.datetime.now().strftime("%d_%m_%Y_%H_%M")
#DATA_DIR = '/data/%s' % datetime.datetime.now().strftime("%d_%m_%Y_%H_%M_%S_%f")

RESOURCES_DIR = '/Users/ashraov/projects/study/diploma/resources'
#RESOURCES_DIR = '/opt/diploma/resources'

SURF_DIR = '%s/surf' % DATA_DIR
FRAME_DIR = '%s/frame' % DATA_DIR
WAVE_DIR = '%s/wave' % DATA_DIR
JSON_DIR = '%s/json' % DATA_DIR
LOG_DIR = '%s/log' % DATA_DIR

# NOTE:
# * good mesh: pqIaD
# * worse mesh: pq10IaDX

# sup - pq5IaDX

MESH_TYPE = 'pq5IaDX'
MESH_FILENAME = 'lake_superior.poly'
MAX_PROCESSES = 2

os.makedirs(LOG_DIR, exist_ok=True)
log_name = '%s/%s.log' % (LOG_DIR, datetime.datetime.now().strftime("%d_%m_%Y_%H_%M"))
logging.basicConfig(filename=log_name, level=logging.DEBUG)

def main():
    mesh = m.Mesh(RESOURCES_DIR + '/poly/%s' % MESH_FILENAME)
    mesh.generate(MESH_TYPE)
    mesh.generate_contour()

    #mesh.show()
    #mesh.draw_contour()
    logging.info(mesh.quantity)

    # interval of integration (t0, tf)
    t_span = [1.90, 1.91]
    # times at which to store the computed solution, must be sorted and lie within t_span
    t_eval = [1.902, 1.905, 1.908]

    #solution, times, execution_time = fem.Solver(MAX_PROCESSES, mesh, t_span, t_eval).solve()

    #logging.info('[INFO] fem algorithm worked for %s minutes' % str(execution_time))

    solution = np.array([[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[2.85704314608092],[2.85163075120540],[2.85704151177042],[2.86786246259106],[2.86786368167229],[2.87868756903445],[2.87868591821523],[2.88950711278526],[2.88950808316057],[2.90574168901935],[2.91115239209653],[2.90574125661583],[2.91115236175356],[2.91656357239147],[2.92197469044222],[2.92738632449461],[2.93279644473575],[2.93820853120540],[2.94361867185988],[2.94903029796546],[2.95985243701671],[2.97067598305042],[2.96526335489931],[2.97067414961463],[2.98149616178860],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[2.85704208056888],[2.85163143407673],[2.85704244197119],[2.86786394750435],[2.86786437203479],[2.87868702759785],[2.87868624566788],[2.88950779926480],[2.88950798362442],[2.90574124900479],[2.91115280893884],[2.90574215952810],[2.91115261617321],[2.91656385245265],[2.92197460714501],[2.92738615909760],[2.93279710676077],[2.93820804286366],[2.94361892219461],[2.94903066379956],[2.95985189317986],[2.97067434444750],[2.96526391186433],[2.97067458205886],[2.98149693140221],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[-9.98087604174454e-6],[-6.81465593733347e-6],[-5.06359879470709e-6],[7.63215912588759e-6],[-4.08047649771287e-6],[-1.43179718393573e-5],[-2.86179732082858e-6],[-1.00156714620224e-5],[-7.40051388253124e-6],[4.02934617350976e-6],[5.48771167060329e-6],[-6.02058686952908e-6],[3.32519813089890e-6],[6.99140376286915e-6],[7.67796863033577e-6],[8.82812741051297e-6],[3.85286393823905e-6],[-8.26722961512019e-6],[-1.46049135352701e-6],[9.26187208049168e-6],[4.83458084607860e-6],[3.18266875761028e-7],[-8.49680559344060e-6],[5.68031376883467e-6],[7.01061394432138e-6],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0],[0]])
    times = np.array([1.0])

    #np_array.write(JSON_DIR, 'solution.json', solution)
    #np_array.write(JSON_DIR, 'times.json', times)

    logging.info('[INFO] json data was recorded')

    q1, q2, H, psi1, psi2 = get_functions(mesh, solution, times)

    # surface q1
    tri_plot.draw_3d_surf(SURF_DIR, 'q_1', q1, times)
    gif.create('%s/q_1' % SURF_DIR)
    # frame q1
    tri_plot.draw_3d_frame(FRAME_DIR, 'q_1', q1, times)
    gif.create('%s/q_1' % FRAME_DIR)

    # surface q2
    tri_plot.draw_3d_surf(SURF_DIR, 'q_2', q2, times)
    gif.create('%s/q_2' % SURF_DIR)
    # frame q2
    tri_plot.draw_3d_frame(FRAME_DIR, 'q_2', q2, times)
    gif.create('%s/q_2' % FRAME_DIR)

    # surface H
    tri_plot.draw_3d_surf(SURF_DIR, 'H', H, times)
    gif.create('%s/H' % SURF_DIR)
    # frame H
    tri_plot.draw_3d_frame(FRAME_DIR, 'H', H, times)
    gif.create('%s/H' % FRAME_DIR)

    # wave function psi1
    cs.draw_psi_2d(WAVE_DIR, 'psi_1', psi1, times, mesh)
    gif.create('%s/psi_1' % WAVE_DIR)

    # wave function psi2
    cs.draw_psi_2d(WAVE_DIR, 'psi_2', psi2, times, mesh)
    gif.create('%s/psi_2' % WAVE_DIR)


if __name__ == "__main__":
    main()
